# 콘서트 예약 서비스 요구사항 분석
## 요약
* 콘서트 예약 서비스를 구현한다.
* 대기열 시스템을 구축하고, 예약 서비스는 작업가능한 유저만 수행할 수 있도록 해야한다.
* 사용자는 좌석 예약 시에 미리 충전한 잔액을 이용한다.
* 좌석 예약 요청시에, 결제가 이루어지지 않더라도 일정 시간동안 다른 유저가 해당 좌석에 접근할 수 없도록 한다.
  
## 대기열 시스템 구축의 목적
* 한 시점에 처리할 수 있는 총 트래픽 양은 제한되어 있다.
* 동시에 다수의 요청이 몰릴 경우 서버 과부하로 인해 다운될 위험이 존재한다. <br/>
  이를 방지하기 위해 대기열 시스템은 요청별로 적절한 대기 시간을 부여하여 처리 속도를 조정하므로써 <br/>
  **서버 부하를 분산**시키고 **안정적인 서비스**를 제공한다.

* 대기열이 필요한 상황 : 업데이트가 일어날 때
   * 좌석 예약 요청 API
   * 잔액 충전 / 조회 API
   * 결제 API
   
## 요구사항
### 1. 유저 대기열 토큰 발급 API
* 서비스를 이용할 토큰을 발급받는 API를 작성한다.
* 토큰은 유저의 UUID 와 해당 유저의 대기열을 관리할 수 있는 정보 ( 대기 순서 or 잔여 시간 등 ) 를 포함한다.
* 이후 모든 API 는 위 토큰을 이용해 대기열 검증을 통과해야 이용 가능하다. </br>
  (기본적으로 폴링으로 본인의 대기열을 확인한다고 가정하며, 다른 방안 또한 고려해보고 구현해 볼 수 있습니다.)

#### KEY POINT
* 유저간 대기열을 요청 순서대로 정확하게 제공할 방법을 고민한다.
* 동시에 여러 사용자가 예약 요청을 했을 때, 좌석이 중복으로 배정 가능하지 않도록 한다.

#### 기능 분석
```
1. 유저마다 각각의 대기열 토큰을 생성해야 한다.
2. 대기열 토큰 정보에는 UUID을 포함한다.
   * 대기열 테이블 : 대기열Id, 유저Id(UUID), 대기열상태, 토큰생성시각, 토큰만료시각, 토큰제거시각

3. 대기열 검증 통과 과정
3-1. 사용자 요청(토큰) 대기열 진입 시 초기 대기열 상태 : 'wait'
3-2. 사용자 요청(토큰) 검증 시 정상이면 대기열 상태 변경 후 진입, 활성시간 부여(+5분) : 'active'
3-3. 사용자 요청(토큰)의 활성시간 만료 시 대기열 상태 변경, 토큰제거시간 업데이트 : 'expire'
```
### 2. 예약 가능 날짜 / 좌석 API
* 예약 가능한 날짜와 해당 날짜의 좌석을 조회하는 API 를 각각 작성한다.
* 예약 가능한 날짜 목록을 조회할 수 있다.
* 날짜 정보를 입력받아 예약가능한 좌석정보를 조회할 수 있다.
  (좌석 정보는 1 ~ 50 까지의 좌석번호로 관리된다.)
  
#### 기능 분석
```
1. 예약 가능한 날짜 조회 후 목록으로 반환
1-1. 데이터 없으면 NotFoundException 발생
1-2. 데이터 있으면 콘서트 예약 가능한 날짜 반환
    * 콘서트 테이블 : 콘서트Id, 콘서트 이름
    * 콘서트 스케줄 테이블 : 스케줄Id, 콘서트Id, 가격, 콘서트일자, 예약가능시간, 예약종료시간, 
     잔여 티켓수
     
2. 예약 가능한 날짜 중 하나로 입력하여 예약 가능한 좌석 조회
2-1. 1~50까지 좌석을 먼저 저장한다.
2-1. 데이터 없으면 NotFoundException 발생
2-2. 데이터 있으면 예약 가능한 좌석 정보 반환
    * 좌석 테이블 : 좌석Id, 콘서트 스케줄Id, 좌석번호, 좌석상태(점유/비점유), 좌석가격, 
     생성시각, 수정시각
```

### 3. 좌석 예약 요청 API
* 날짜와 좌석 정보를 입력받아 좌석을 예약 처리하는 API 를 작성한다.
* 좌석 예약과 동시에 해당 좌석은 그 유저에게 약 5분간 임시 배정된다. 
  (시간은 정책에 따라 자율적으로 정의한다.)
* 만약 배정 시간 내에 결제가 완료되지 않는다면 좌석에 대한 임시 배정은 해제되어야 하며 다른 사용자는 예약할 수 있어야 한다.

#### 기능 분석
```
- 날짜, 좌석id, 유저토큰으로 예약 요청

1. 날짜, 좌석id으로 좌석 조회
1-1. 날짜와 좌석id와 일치하는 좌석 데이터가 있는지 조회한다.
1-1-1. 데이터가 없으면 throw NotFoundException이 발생한다.
1-1-2. 데이터가 있으면 예약 테이블에 좌석 정보를 저장한다.

2. 좌석 예약 요청
2-1. 좌석 테이블의 좌석상태(점유/비점유)를 점유로 업데이트한다.
2-2. 예약 테이블에 업데이트 정보를 저장한다.
     * 예약 테이블 : 예약Id, 사용자Id(토큰), 좌석Id, 예약상태(예약대기, 결제완료, 예약취소), 
     좌석가격, 생성시각
     
**
대기열 검증 통과 과정
- 좌석 데이터 조회 시 대기열 진입 
1. 사용자 요청(토큰) 대기열 진입 시 초기 대기열 상태 : 'wait'
2. 사용자 요청(토큰) 검증 시 정상이면 대기열 상태 변경 후 진입, 활성시간 부여(+5분) : 'active'
3. 사용자 요청(토큰)의 활성시간 만료 시 대기열 상태 변경, 토큰제거시간 업데이트 : 'expire'
**
```

### 4. 잔액 충전 / 조회 API
* 결제에 사용될 금액을 API 를 통해 충전하는 API 를 작성한다.
* 사용자 식별자 및 충전할 금액을 받아 잔액을 충전한다.
* 사용자 식별자를 통해 해당 사용자의 잔액을 조회한다.

#### 기능 분석
```
- 충전할 금액, 유저토큰으로 잔액 충전 요청

1, 충전할 금액, 유저토큰으로 잔액 조회
1-1. 유저토큰의 사용자 정보로 잔액 조회한다.
1-1-1. 데이터 없으면 NotFoundException 발생힌다.
1-1-2. 데이터 있으면 충전 금액으로 충전 요청한다. 

2. 잔액 충전 요청 
2-1. 잔액을 기존 금액 + 충전 금액 한 뒤 업데이트한다.
2-2. 사용자 테이블에 업데이트 정보를 저장한다.
     * 사용자 테이블 : 사용자Id, 사용자명, 포인트 잔액, 생성시각, 수정시각

**
대기열 사용X, 동시성 제어만 해줌.
- 충전할 금액, 유저토큰으로 잔액 조회 시 락을 생성
1. 데이터베이스 레벨에서 비관적락 걸어줌.
**
```

### 5. 결제 API
* 결제 처리하고 결제 내역을 생성하는 API 를 작성한다.
* 결제가 완료되면 해당 좌석의 소유권을 유저에게 배정하고 대기열 토큰을 만료시킨다.

#### 기능 분석
```
기능 분석
- 예약Id, 좌석번호, 유저토큰으로 결제 요청

1. 예약Id와 좌석번호와 일치하는 예약 데이터 있는지 조회
1-1. 데이터 없으면 NotFoundException 발생한다.
1-2. 데이터 있으면 예약 정보로 결제를 요청한다.

2. 결제 처리 및 결제 내역 생성
2-1. 사용자 데이터 조회한다.
2-1-1. 사용자 잔액 < 결제 금액, throw LackaBlanceException 발생
2-1-2. 그 반대면 사용자 잔액 - 결제 금액한 금액으로 잔액 업데이트
2-2. 사용자 테이블에 업데이트 내용 저장한다.

2-3. 예약 정보에서 예약 상태를 '결제완료'로 업데이트한다.
2-4. 예약 테이블에 업데이트 정보를 저장한다.
2-5. 결제 테이블에 예약 데이터로 세팅한 후 저장한다.
    * 결제 테이블 : 결제Id, 예약Id, 좌석번호, 콘서트명, 콘서트일시, 결제금액, 결제상태, 결제시각, 생성시각

**
대기열 검증 통과 과정
- 예약Id와 좌석번호와 예약 데이터 조회 시 대기열 진입 
1. 사용자 요청(토큰) 대기열 진입 시 초기 대기열 상태 : 'wait'
2. 사용자 요청(토큰) 검증 시 정상이면 대기열 상태 변경 후 진입, 활성시간 부여(+5분) : 'active'
3. 사용자 요청(토큰)의 활성시간 만료 시 대기열 상태 변경, 토큰제거시간 업데이트 : 'expire'
**
```

